
{% extends 'base.html' %}
{% load static %}
{% block content %}
<h2 class="text-center mt-3">Local Popularity Map</h2>
<hr>

<div style="display:flex; gap:1rem;">
  <div id="map" style="height: 600px; width: 70%;"></div>

  <aside id="region-info" style="width:30%; max-height:600px; overflow:auto; padding:1rem; border:1px solid #ddd;">
    <h3 id="region-title">Select a region</h3>
    <ul id="region-top-list"></ul>
     <hr />
    <h4>My recent purchases</h4>
    <ul id="my-purchases-list"></ul>
  </aside>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  var map = L.map("map").setView([37.8, -96], 4);
  window.map = map;
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 12, attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  var aside = document.getElementById('region-info');
  aside.innerHTML = '<h3 id="region-title">Select a region</h3><ul id="region-top-list"></ul>';

  fetch("{% url 'movies.locations_geojson' %}", { credentials: 'same-origin' })
    .then(function (res) {
      if (!res.ok) throw new Error('locations-geojson network response not ok: ' + res.status);
      return res.json();
    })
    .then(function (data) {
      var features = data.features || [];
      if (!features.length) {
        document.getElementById('region-title').textContent = "No trending locations yet.";
        return;
      }

      window.topMoviesByRegion = data.top_movies_by_region || {};

      var bounds = [];
      features.forEach(function (f) {
        var coords = f.geometry && f.geometry.coordinates;
        if (!coords) return;
        var lng = coords[0], lat = coords[1];
        var p = f.properties || {};
        var movieName = p.movie || p.movie_name || "(unknown)";
        // Use purchase_count as the canonical metric for display
        var purchaseCount = (p.purchase_count != null) ? p.purchase_count : 0;
        var radius = Math.max(6, Math.sqrt(Math.max(0, purchaseCount)) * 2);

        var circle = L.circleMarker([lat, lng], {
          radius: radius,
          color: "#ff5722",
          fillColor: "#ff8a50",
          fillOpacity: 0.8
        }).addTo(map);

        circle.bindPopup("<b>" + movieName + "</b><br>" + (p.place || p.name || "") + "<br>Purchases: " + purchaseCount);

        // single click handler: prefer server-side top list by id, fallback to local data
        circle.on('click', function () {
          var regionName = p.place || p.name || movieName;
          if (p.id) {
            fetchRegionTopById(p.id, regionName);
          } else {
            showRegionTopMovies(regionName);
          }
        });

        bounds.push([lat, lng]);
      });

      if (bounds.length) {
        map.fitBounds(bounds);
      }

      function clearTopList() {
        var list = document.getElementById('region-top-list');
        list.innerHTML = '';
        return list;
      }

      function fetchRegionTopById(regionId, regionName) {
        document.getElementById('region-title').textContent = "Top movies in: " + (regionName || regionId);
        var list = clearTopList();

        fetch("/movies/region/" + encodeURIComponent(regionId) + "/top/", { credentials: 'same-origin' })
          .then(function (res) {
            if (!res.ok) throw new Error('region top fetch failed: ' + res.status);
            return res.json();
          })
          .then(function (items) {
            if (!items || !items.length) {
              var li = document.createElement('li');
              li.textContent = 'No top movies found.';
              list.appendChild(li);
              return;
            }
            items.forEach(function (item) {
              var li = document.createElement('li');
              li.textContent = (item.title || item.movie || "(unknown)") + " — " + (item.count || item.purchase_count || 0);
              list.appendChild(li);
            });
          })
          .then(function (data) {
            // view returns { top: [...] } — normalize to an array
            var items = [];
            if (Array.isArray(data)) items = data;
            else if (Array.isArray(data.top)) items = data.top;

            if (!items.length) {
             var li = document.createElement('li');
              li.textContent = 'No top movies found.';
              list.appendChild(li);
              return;
            }
            items.forEach(function (item) {
              var li = document.createElement('li');
              li.textContent = (item.title || item.movie || "(unknown)") + " — " + (item.count || item.purchase_count || 0);
              list.appendChild(li);
            });
          })
           .catch(function (err) {
             console.error("region top error", err);
             showRegionTopMovies(regionName);
           });
      }

function showRegionTopMovies(regionName) {
        document.getElementById('region-title').textContent = "Top movies in: " + (regionName || "(unknown)");
        var list = clearTopList();
        var items = (window.topMoviesByRegion && window.topMoviesByRegion[regionName]) || [];
        if (!items.length) {
          var li = document.createElement('li');
          li.textContent = 'No top movies available.';
          list.appendChild(li);
          return;
        }
        items.forEach(function (item) {
          var li = document.createElement('li');
          li.textContent = (item.title || item.movie || "(unknown)") + " — " + (item.count || item.purchase_count || 0);
          list.appendChild(li);
        });
      }
    })
    .catch(function (err) {
      console.error("locations-geojson error", err);
    });
});
</script>

{% endblock %}